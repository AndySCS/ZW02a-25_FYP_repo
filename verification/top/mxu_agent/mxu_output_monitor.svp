class top_output_monitor extends uvm_monitor;

    virtual top_intf top_if;
    int send_cnt;
    uvm_analysis_port #(top_tr) ap;

    `uvm_component_utils(top_output_monitor)
    function new(string name = "top_output_monitor", uvm_component parent = null);
       super.new(name, parent);
    endfunction //new()
    
    extern function void build_phase(uvm_phase phase);
    extern virtual task main_phase(uvm_phase phase);
    
    extern virtual task collect_matrix_out(top_tr tr);
    extern virtual function void final_phase(uvm_phase phase);

endclass //top_output_monitor extends superClass

function void top_output_monitor::build_phase(uvm_phase phase);
    super.build_phase(phase);
    if(!uvm_config_db#(virtual top_intf)::get(this, "", "top_if", top_if))begin
        `uvm_fatal("top_output_monitor", "top output_monitor fail to get top if")
    end
    ap = new("ap", this);
endfunction

task top_output_monitor::main_phase(uvm_phase phase);
    top_tr tr;

    tr = new("tr");

    while (1) begin 
        this.collect_matrix_out(tr);
        ap.write(tr);
    end

endtask

task top_output_monitor::collect_matrix_out(top_tr tr);

    while(1)begin
        @(posedge top_if.clk);
        if(top_if.lsu_top_vld & top_if.top_lsu_rdy) break;
    end

    //tr.clear_result();
    while(1) begin
    @(negedge top_if.clk);
    //wait(top_if.top_lsu_data_rdy & top_if.top_lsu_rdy) 
        if(top_if.top_lsu_data_rdy & top_if.top_lsu_rdy & ~(|{top_if.lsu_top_iram_vld, top_if.lsu_top_wram_vld})) begin
            `uvm_info("top_output_monitor", "begin collect result", UVM_MEDIUM)
            send_cnt++;
            //:for($row=0;$row<16;$row++){
            //:for($col=0;$col<16;$col++){
            tr.matrix_result_int16[{$row}][{$col}] = {{{{16{{top_if.top_lsu_int16_row{$row}_data[{15+16*$col}]}}}},top_if.top_lsu_int16_row{$row}_data[{15+16*$col}:{0+16*$col}]}};
            tr.matrix_result_int8[{$row}][{$col}] = {{{{24{{top_if.top_lsu_int8_row{$row}_data[{7+8*$col}]}}}},top_if.top_lsu_int8_row{$row}_data[{7+8*$col}:{0+8*$col}]}};
            //:}
            //:}
            break;
        end
    end

endtask

function void top_output_monitor::final_phase(uvm_phase phase);
    super.final_phase(phase);
    `uvm_info("top_omon", $sformatf("enter fianl phase, top_omon send cnt is %d", send_cnt), UVM_LOW);
endfunction
